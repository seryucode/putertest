<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>4-Model Multi Chat</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body { font-family: "Hiragino Kaku Gothic ProN", sans-serif; margin: 0; background: #121212; color: #e0e0e0; height: 100vh; display: flex; flex-direction: column; }
    header { background: #1e1e1e; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
    
    #chat-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
    .msg { max-width: 85%; padding: 14px; border-radius: 12px; line-height: 1.7; white-space: pre-wrap; font-size: 15px; border: 1px solid transparent; }
    .user { align-self: flex-end; background: #2b5278; color: white; }
    .ai { align-self: flex-start; background: #262626; border-color: #333; }
    .forgotten { opacity: 0.3; border-style: dashed; }
    
    footer { background: #1e1e1e; padding: 20px; border-top: 1px solid #333; }
    .ui-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    select { flex: 1; padding: 10px; border-radius: 8px; background: #333; color: white; border: 1px solid #444; font-size: 14px; }
    textarea { width: 100%; height: 80px; padding: 12px; border-radius: 10px; background: #2d2d2d; color: white; border: 1px solid #444; resize: none; font-family: inherit; font-size: 16px; box-sizing: border-box; }
    button { padding: 0 25px; background: #007bff; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
    button:hover { background: #0056b3; }
    button:disabled { background: #555; cursor: not-allowed; }
  </style>
</head>
<body>

  <header>
    <div style="font-weight:bold; letter-spacing:1px;">ğŸ–‹ï¸ MULTI-MODEL WRITER</div>
    <button onclick="clearHistory()" style="background:#cc3300; font-size:11px; padding:5px 10px;">å…¨å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
  </header>

  <div id="chat-container"></div>

  <footer>
    <div class="ui-row">
        <label style="font-size:12px; color:#aaa;">MODEL:</label>
        <select id="modelSelect">
            <option value="claude-opus-4-5-latest">ğŸ‘‘ Claude Opus 4.5 (æœ€é«˜å³°ãƒ»é‡åš)</option>
            <option value="claude-3-7-sonnet-latest">âš¡ Claude 3.7 Sonnet (æœ€æ–°ãƒ»é‹­ã„)</option>
            <option value="deepseek/deepseek-r1:free">ğŸ§  DeepSeek R1 (ç„¡æ–™ãƒ»è«–ç†æ€è€ƒ)</option>
            <option value="meta-llama/llama-3.3-70b-instruct:free">ğŸ¦™ Llama 3.3 70B (ç„¡æ–™ãƒ»è¡¨ç¾è±Šã‹)</option>
        </select>
        <span id="mem-info" style="font-size:11px; color:#666;"></span>
    </div>
    <div style="display:flex; gap:10px;">
        <textarea id="prompt" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›... (æœ€åˆã®1é€šç›®ãŒæ°¸ä¹…ä¿å­˜ã•ã‚Œã‚‹è¨­å®šã«ãªã‚Šã¾ã™)"></textarea>
        <button id="sendBtn" onclick="sendMessage()">é€ä¿¡</button>
    </div>
  </footer>

  <script>
    let history = [];
    const CONTEXT_WINDOW = 10; // æœ€æ–°ä½•ä»¶ã‚’è¨˜æ†¶ã«å«ã‚ã‚‹ã‹

    window.onload = async () => {
        const saved = localStorage.getItem('multi_model_chat');
        if (saved) { history = JSON.parse(saved); renderChat(); }
        if (!puter.auth.isSignedIn()) await puter.auth.signIn();
    };

    function clearHistory() {
        if(confirm("å…¨å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
            history = [];
            localStorage.removeItem('multi_model_chat');
            renderChat();
        }
    }

    function renderChat() {
        const container = document.getElementById('chat-container');
        container.innerHTML = '';
        history.forEach((m, idx) => {
            const isForgotten = (idx > 0 && idx < history.length - CONTEXT_WINDOW);
            const div = document.createElement('div');
            div.className = `msg ${m.role === 'user' ? 'user' : 'ai'} ${isForgotten ? 'forgotten' : ''}`;
            div.innerText = m.content;
            container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
        document.getElementById('mem-info').innerText = `Total: ${history.length}`;
    }

    async function sendMessage() {
        const input = document.getElementById('prompt');
        const text = input.value.trim();
        if (!text) return;

        history.push({ role: "user", content: text });
        renderChat();
        input.value = "";
        
        const model = document.getElementById('modelSelect').value;
        const btn = document.getElementById('sendBtn');
        btn.disabled = true;

        try {
            let context = [];
            if (history.length > 0) context.push(history[0]); // 1é€šç›®ã¯çµ¶å¯¾
            const recent = history.slice(-CONTEXT_WINDOW);
            recent.forEach(m => { if (m !== history[0]) context.push(m); });

            const resp = await puter.ai.chat(context, { model: model, stream: true });
            
            let aiMsg = { role: "assistant", content: "" };
            history.push(aiMsg);
            const aiIdx = history.length - 1;

            for await (const part of resp) {
                if (part?.text) {
                    history[aiIdx].content += part.text;
                    renderChat();
                }
            }
            localStorage.setItem('multi_model_chat', JSON.stringify(history));
        } catch (e) {
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
        } finally {
            btn.disabled = false;
        }
    }
  </script>
</body>
</html>
