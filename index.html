<script>
puter.ready(async () => {
  const statusEl = document.getElementById("status");

  if (!puter.auth.isSignedIn()) {
    statusEl.innerText = "❌ Puterにログインしていない";
    return;
  }

  try {
    await puter.ai.getModels();
    statusEl.innerText = "✅ Puter AI 利用可能";
  } catch (e) {
    statusEl.innerText = "❌ Puter AI が有効化されていない";
    console.error(e);
  }

  document.getElementById("btn").onclick = runClaude;
});

async function runClaude() {
  const outputEl = document.getElementById("output");
  const statusEl = document.getElementById("status");
  const btn = document.getElementById("btn");

  outputEl.innerText = "";
  btn.disabled = true;
  statusEl.innerText = "Claudeを呼び出している…";

  const prompt = `
あなたは Claude の文体を持つ作家です。
抑制的で比喩を好み、余白を大切にしてください。

お題：
${document.getElementById("prompt").value}
`;

  try {
    const stream = await puter.ai.chat(prompt, {
      model: "claude",
      stream: true
    });

    statusEl.innerText = "執筆中…";

    let received = false;

    for await (const part of stream) {
      if (part?.text) {
        received = true;
        outputEl.innerText += part.text;
      }
    }

    if (!received) {
      outputEl.innerText = "⚠️ Claudeからの出力がありませんでした";
      statusEl.innerText = "無応答";
    } else {
      statusEl.innerText = "完了";
    }

  } catch (err) {
    console.error(err);
    outputEl.innerText = "❌ エラー:\n" + err.message;
    statusEl.innerText = "失敗";
  } finally {
    btn.disabled = false;
  }
}
</script>
