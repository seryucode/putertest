<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Writer's Studio Complete</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body { font-family: "Hiragino Kaku Gothic ProN", sans-serif; margin: 0; background: #121212; color: #e0e0e0; height: 100vh; display: flex; flex-direction: column; }
    header { background: #1e1e1e; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
    
    #chat-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
    
    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ« */
    .msg { 
        max-width: 85%; 
        padding: 14px; 
        border-radius: 12px; 
        line-height: 1.7; 
        white-space: pre-wrap; 
        font-size: 15px; 
        position: relative; 
        border: 1px solid transparent;
        padding-bottom: 25px; /* ã‚«ã‚¦ãƒ³ã‚¿ç”¨ã‚¹ãƒšãƒ¼ã‚¹ */
    }
    .user { align-self: flex-end; background: #2b5278; color: white; padding-right: 14px; }
    .ai { align-self: flex-start; background: #262626; border-color: #333; padding-top: 35px; }
    
    .forgotten { opacity: 0.3; border-style: dashed; }

    /* ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ */
    .copy-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #333;
        color: #aaa;
        border: 1px solid #444;
        border-radius: 4px;
        font-size: 11px;
        padding: 4px 8px;
        cursor: pointer;
        transition: 0.2s;
    }
    .copy-btn:hover { background: #444; color: white; }

    /* æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ï¼ˆãƒãƒ–ãƒ«å†…ï¼‰ */
    .char-count {
        position: absolute;
        bottom: 5px;
        right: 10px;
        font-size: 10px;
        color: #888;
        font-family: monospace;
    }
    .user .char-count { color: #ccc; }
    
    footer { background: #1e1e1e; padding: 20px; border-top: 1px solid #333; }
    .ui-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
    select { flex: 1; padding: 10px; border-radius: 8px; background: #333; color: white; border: 1px solid #444; font-size: 14px; }
    
    /* å…¥åŠ›ã‚¨ãƒªã‚¢å‘¨ã‚Š */
    .input-area { display: flex; gap: 10px; align-items: flex-end; }
    textarea { width: 100%; height: 80px; padding: 12px; border-radius: 10px; background: #2d2d2d; color: white; border: 1px solid #444; resize: none; font-family: inherit; font-size: 16px; box-sizing: border-box; }
    
    .send-group { display: flex; flex-direction: column; align-items: center; gap: 5px; }
    button.send { width: 80px; height: 50px; background: #007bff; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
    button.send:hover { background: #0056b3; }
    button.send:disabled { background: #555; cursor: not-allowed; }
    
    #input-counter { font-size: 10px; color: #888; font-family: monospace; }
  </style>
</head>
<body>

  <header>
    <div style="font-weight:bold; letter-spacing:1px;">ğŸ–‹ï¸ WRITER'S STUDIO <span style="font-size:10px; color:#666;">v3.0</span></div>
    <button onclick="clearHistory()" style="background:#cc3300; color:white; border:none; border-radius:4px; font-size:11px; padding:5px 10px; cursor:pointer;">å…¨å±¥æ­´ãƒªã‚»ãƒƒãƒˆ</button>
  </header>

  <div id="chat-container"></div>

  <footer>
    <div class="ui-row">
        <label style="font-size:12px; color:#aaa;">MODEL:</label>
        <select id="modelSelect">
            <option value="claude-opus-4-5-latest">ğŸ‘‘ Claude Opus 4.5 (æœ€é«˜å³°)</option>
            <option value="claude-3-7-sonnet-latest">âš¡ Claude 3.7 Sonnet (æœ€æ–°é‹­)</option>
            <option value="deepseek/deepseek-r1:free">ğŸ§  DeepSeek R1 (ãƒ—ãƒ­ãƒƒãƒˆç”¨)</option>
            <option value="meta-llama/llama-3.3-70b-instruct:free">ğŸ¦™ Llama 3.3 (ã‚µãƒ–ç”¨)</option>
        </select>
        <span id="mem-info" style="font-size:11px; color:#666;"></span>
    </div>
    
    <div class="input-area">
        <textarea id="prompt" placeholder="ã“ã“ã«æŒ‡ç¤ºã‚’å…¥åŠ›..." oninput="updateInputCount()"></textarea>
        <div class="send-group">
            <span id="input-counter">0æ–‡å­—</span>
            <button class="send" id="sendBtn" onclick="sendMessage()">é€ä¿¡</button>
        </div>
    </div>
  </footer>

  <script>
    let history = [];
    const CONTEXT_WINDOW = 10; 

    window.onload = async () => {
        const saved = localStorage.getItem('multi_model_chat_v3');
        if (saved) { history = JSON.parse(saved); renderChat(); }
        if (!puter.auth.isSignedIn()) await puter.auth.signIn();
        updateInputCount();
    };

    function updateInputCount() {
        const len = document.getElementById('prompt').value.length;
        document.getElementById('input-counter').innerText = len + "æ–‡å­—";
    }

    function clearHistory() {
        if(confirm("å…¨å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
            history = [];
            localStorage.removeItem('multi_model_chat_v3');
            renderChat();
        }
    }

    function renderChat() {
        const container = document.getElementById('chat-container');
        container.innerHTML = '';
        history.forEach((m, idx) => {
            const isForgotten = (idx > 0 && idx < history.length - CONTEXT_WINDOW);
            const div = document.createElement('div');
            div.className = `msg ${m.role === 'user' ? 'user' : 'ai'} ${isForgotten ? 'forgotten' : ''}`;
            
            // æœ¬æ–‡
            const textSpan = document.createElement('span');
            textSpan.innerText = m.content;
            div.appendChild(textSpan);

            // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿
            const countSpan = document.createElement('span');
            countSpan.className = 'char-count';
            countSpan.innerText = m.content.length + "æ–‡å­—";
            div.appendChild(countSpan);

            // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆAIã®ã¿ï¼‰
            if (m.role === 'assistant') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.innerText = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼';
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(m.content);
                    copyBtn.innerText = 'âœ… å®Œäº†';
                    setTimeout(() => copyBtn.innerText = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼', 2000);
                };
                div.appendChild(copyBtn);
            }

            container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
        document.getElementById('mem-info').innerText = `Msg: ${history.length}`;
    }

    async function sendMessage() {
        const input = document.getElementById('prompt');
        const text = input.value.trim();
        if (!text) return;

        history.push({ role: "user", content: text });
        renderChat();
        input.value = "";
        updateInputCount(); // ãƒªã‚»ãƒƒãƒˆ
        
        const model = document.getElementById('modelSelect').value;
        const btn = document.getElementById('sendBtn');
        btn.disabled = true;

        try {
            let context = [];
            if (history.length > 0) context.push(history[0]); 
            const recent = history.slice(-CONTEXT_WINDOW);
            recent.forEach(m => { if (m !== history[0]) context.push(m); });

            const resp = await puter.ai.chat(context, { model: model, stream: true });
            
            let aiMsg = { role: "assistant", content: "" };
            history.push(aiMsg);
            const aiIdx = history.length - 1;

            for await (const part of resp) {
                if (part?.text) {
                    history[aiIdx].content += part.text;
                    renderChat(); // ã“ã“ã§æ–‡å­—æ•°ã‚‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã•ã‚Œã‚‹
                }
            }
            localStorage.setItem('multi_model_chat_v3', JSON.stringify(history));
        } catch (e) {
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
        } finally {
            btn.disabled = false;
        }
    }
  </script>
</body>
</html>
